<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Jeca Maracatu</title>

    <link rel="icon" href="img/jeca-logo.png">
</head>
<body>
    <div id="game">
        <header>
            <div class="log">
            <h2>游낽</h2>
            <h1>JecaMaracatu</h1>
            </div>
        <nav>
           <button>丘뙖잺</button>
           <button>游</button>
           <button>游</button>
           <button>游녻</button>
        </nav>
        </header>
    </div>

    <main>

        <!-- colis칚o -->
        <img id="mesa1" src="img-cenario/Mesa.png">
        <img id="mesa2" src="img-cenario/Mesa.png">
        <img id="mesa3" src="img-cenario/Mesa.png">
        <img id="QUADRADO" draggable="true">
        <div id="parede"></div>
        <div id="parede2"></div>
        <div id="chao"></div>

        <div id="cozinha">
            <img id="espatula" src="img/espatula.png" draggable="true">
        </div>

        <img id="janela" src="img-cenario/Janela.gif">

        <!-- game area -->
        <div id="game-area">

            <img src="img/Jeca-paradoR.gif" id="player" class="player" alt="Player">

            <img src="img-cenario/fundo.png" alt="fundo" class="fundo">
        </div>
              
    </main>

        <script>
            const mesa = document.getElementById('mesa1')
            const main = document.querySelector('main');
            const gameArea = document.getElementById('game-area');
            const player = document.getElementById('player');
            const espatula = document.getElementById('espatula');
            const kitchen = document.getElementById('cozinha')
            // vari치vel dos clientes
            let client = [];
            // dps de selecionados, os clientes saem do array client e entram no client clicado para serem depositados nas mesas, s칩 sair칚o desse array dps de cozinhar para eles
            let clientClicado = [];
            const maxClients = 3;
            let occupiedPositions = new Set();
            // vari치vel para passar os arrays de defini칞칫es
            let num = 0
            // posi칞칚o dos clientes esperando na entrada
            // se a dimens칚o de um for 50px, a dist칙ncia um do outro dever치 ser maior que essa dimens칚o
            // 3 clientes esperando por vez
            // rela칞칚o de camada entre eles. O mais da frente dever치 ter um z-index maior
            // 130, 70, 10
            const clientPositions = {
                1: 100,
                2: 50,
                3: 0
            }
            // est칚o se sobrepondo
            const zclient = {
                0: 1,
                50: 2,
                100: 3
            }

            // personagens
            const clientImg = [
                "aly.gif",
                "berimbal.gif",
                "graal.gif",
                "leandro.gif",
                "marrye.gif",
                "nox.gif",
                "pariz.gif",
                "pinguin.gif",
                "tiao-filho.gif"
            ]

            // movimenta칞칚o
            let endposition
            let move = false 
            let posX = 300; // posi칞칚o inicial (meio)
            let posY = 200;

            let mesa2Y = 1000
            let mesa3Y = 350

            let loop = 0;
            let count = 0;

            let targetX = posX;
            let targetY = posY;
            const speed = 6; // velocidade do movimento

            function criarCliente() {

                // defini칞칫es para cada cliente
                num++

                let pos = clientPositions[num];
                let z = zclient[pos];

                occupiedPositions.add(pos);
                console.log(occupiedPositions)

                const clientDiv = document.createElement('img');
                clientDiv.classList.add('cliente');
                clientDiv.style.left = `${pos}px`;
                clientDiv.style.zIndex = `${z}`;   


                // Define o pedido do cliente
                const possibleColors = ['red', 'blue', 'yellow', 'orange', 'green', 'purple', 'brown'];
                let order = [];
                // random recebe possible[numero]
                const randomColor = possibleColors[Math.floor(Math.random() * possibleColors.length)];
                // order recebe o que est치 dentro de random
                order.push(randomColor);
                // clientDiv.style.backgroundColor = `${randomColor}`; 
                // clientDiv.style.color = "red";

                // Define o sprite do personagem
                // random recebe possible[numero]
                console.log("escolhendo sprite...")
                const randomSprite = clientImg[Math.floor(Math.random() * clientImg.length)];
                console.log(`sprite escolhido ${randomSprite}`)
                clientDiv.src = `img/${randomSprite}`; 


                // guarda os dados do cliente no pr칩prio elemento html
                // <div data-order='{"item":"pizza","quantity":2}'></div> (exemplo)
                clientDiv.dataset.order = JSON.stringify(order);
                clientDiv.dataset.position = pos;
                clientDiv.dataset.zindex = z;
                // clientDiv.dataset.persona = 
                console.log(clientDiv.dataset.order);

                gameArea.appendChild(clientDiv);
                client.push(clientDiv)


                // sumir quando clicar e fazer as devidas mudan칞as para depois coloc치-lo na mesa
                clientDiv.addEventListener('click', () => {
                    if (clientClicado.length > 0) {
                        console.log("J치 tem cliente clicado");
                        return;
                    }

                    if (!clientClicado.includes(clientDiv)) {
                        // esconde o cliente
                        clientDiv.hidden = true;
                        // libera a posi칞칚o dele
                        occupiedPositions.delete(pos);
                        // adiciona no cliente clicado, e s칩 poder치 adicionar uma vez, para n칚o poder clicar em mais de um cliente antes de colocar o outro em uma mesa
                        clientClicado.push(clientDiv);
                        console.log(`Acrescentado no array: ${clientClicado}`);
                    }
                    }, { once: true });
            }

                // fun칞칚o que garante apenas 3 clientes e s칩 cria outros 3 novos dps de eliminar os antigos 3
            function clientes3() {

                // reinicia a contagem
                num = 0

                let create = 0;
                const interval = setInterval(() => {
                if (create < maxClients) {
                    criarCliente();
                    create++;
                    console.log("criando mais um cliente")
                } else {
                    clearInterval(interval)
                }
                }, 500);
            }


            // Atualiza posi칞칚o do personagem a cada frame
            function update() {

                const dx = targetX - posX;
                const dy = targetY - posY;
                //calcula a diferen칞a de dist칙ncia a ser percorrida horizontalmente e verticamente utilizando o teorema de pit치goras
                const distance = Math.sqrt(dx * dx + dy * dy);

                // alterar velocidade junto com este
                if (distance > 3) {
                    move = true
                    console.log("movimentando")
                    console.log(distance)

                    posX += (dx / distance) * speed;
                    posY += (dy / distance) * speed;

                    player.style.left = posX + "px";
                    player.style.top = posY + "px";

                } else if (distance <= 3 && move == true) {
                    move = false
                    
                    if (endposition == "left") {
                    player.src = "img/Jeca-paradoL.gif"
                    }
                    if (endposition == "right") {
                    player.src = "img/Jeca-paradoR.gif"
                    }

                    console.log("fim do movimento")
                    
                }
                requestAnimationFrame(update);
            }

            // function posMouse(e) {
            //     num = console.log(e.offsetX, e.offsetY);
            // }


            espatula.addEventListener('dragstart', e => {
                e.dataTransfer.setData('espat', 'espatula'); // marca o item
            });

            function createTargets() {
                for (let i = 1; i <= 8; i++) {
                    const element = document.createElement("div");
                    element.id = "target" + i;
                    element.style.zIndex = 99999999999;
                    element.dataset.target = 0;
                    element.style.width = "200px";
                    element.style.height = "200px";
                    element.style.position = "absolute";
                    element.style.left = i*50  + 100 + "px";
                    element.style.top  = "80px";
                    element.style.backgroundColor = "red";


                    if (i === 1) {
                        element.style.left = "600px"
                        element.style.top = "500px"
                    }
                    
                    if (i === 2) {
                        element.style.left = "700px"
                        element.style.top = "200px"
                    }
                    if (i === 3) {
                        element.style.left = "600px"
                        element.style.top = "100px"
                    }
                    if (i === 4) {
                        element.style.left = "700px"
                        element.style.top = "400px"
                    }
                    if (i === 5) {
                        element.style.left = "800px"
                        element.style.top = "300px"
                    }
                    if (i === 6) {
                        element.style.left = "500px"
                        element.style.top = "200px"
                    }
                    if (i === 7) {
                        element.style.left = "500px"
                        element.style.top = "400px"
                    }
                    if (i === 8) {
                        element.style.left = "400px"
                        element.style.top = "300px"
                    }


                    element.addEventListener('dragover', e => {
                    e.preventDefault();

                    const data = e.dataTransfer.getData('espat');
                        
                    if (element.dataset.target === "0") {
                        element.dataset.target = "1";
                        count = count + 1;
                        element.style.backgroundColor = "cyan";

                    if (count === 8) {
                        loop = loop + 1;

                        // seleciona todos os alvos
                        const targets = document.querySelectorAll('[id^="target"]');
                        targets.forEach(t => {
                            t.dataset.target = "0";
                            t.style.backgroundColor = "red";
                        });

                        count = 0;
                    }

                    if (loop === 15) {
                        count = 0
                        element.dataset.target = 1
                        const targets = document.querySelectorAll('[id^="target"]');
                        targets.forEach(t => {
                            t.dataset.target = "0";
                            t.style.backgroundColor = "yellow";
                        });

                    }

                    }
                    

                    });

                    cozinha.appendChild(element);
                }
            }

            // Detecta clique e define novo destino
            gameArea.addEventListener('click', (event) => {
                move = true
                const rect = gameArea.getBoundingClientRect();
                targetX = event.clientX - rect.left ; // centraliza no meio do quadrado. Metade dos px do quadrado 
                targetY = event.clientY - rect.top - 70;
            });

            gameArea.addEventListener('click', (event) => {
                const dx = targetX - posX;
                const dy = targetY - posY;
                const distance = Math.sqrt(dx * dx + dy * dy);

                console.log("animation")

                if (targetX < posX) {
                    player.src = "img/Jeca-correndoL.gif"
                    endposition = "left"
                } else {
                    player.src = "img/Jeca-correndoR.gif"
                    endposition = "right"
                }
            });


            function visible() {
                kitchen.style.display = "inline";
            }

            mesa.addEventListener('click', visible);

            update(); // inicia loop de anima칞칚o
            createTargets();
            clientes3(); //cria os clientes e a l칩gica dos 3 clientes

    
        </script>
</body>
</html>